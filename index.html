
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  const FIXED_EUR_RATE = 0.92; // 1 USD = 0.92 EUR (fix)
  const OUNCE_TO_GRAM = 31.1035;

  async function loadLBMAData() {
    const response = await fetch('https://api.codetabs.com/v1/proxy/?quest=https://prices.lbma.org.uk/json/gold_pm.json');
    const json = await response.json();

    const records = json.filter(e => e.v && e.v[0] > 0);
    const dates = records.map(e => e.d);
    const usdPerOunce = records.map(e => e.v[0]);
    const eurPerGram = usdPerOunce.map(v => (v / OUNCE_TO_GRAM) * FIXED_EUR_RATE);

    const gramsInput = document.getElementById('gramInput');
    const ctx = document.getElementById('chart').getContext('2d');

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: `Preis für ${gramsInput.value}g (EUR)`,
          data: eurPerGram.map(v => v * gramsInput.value),
          borderColor: '#d4af37',
          borderWidth: 2,
          pointRadius: 3,
          fill: false
        }]
      },
      options: {
        plugins: {
          datalabels: {
            align: 'top',
            color: '#444',
            font: { weight: 'bold', size: 10 },
            formatter: (value) => value.toFixed(2) // shows 2 decimals
          },
          tooltip: { enabled: true },
          legend: { display: true }
        },
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: { title: { display: true, text: 'Datum' }, ticks: { maxTicksLimit: 10 } },
          y: { title: { display: true, text: 'EUR' } }
        }
      },
      plugins: [ChartDataLabels] // enable labels plugin
    });

    gramsInput.addEventListener('input', () => {
      const g = gramsInput.value;
      chart.data.datasets[0].label = `Preis für ${g}g (EUR)`;
      chart.data.datasets[0].data = eurPerGram.map(v => v * g);
      chart.update();
    });
  }

  loadLBMAData().catch(err => {
    console.error('Fehler beim Laden der LBMA-Daten:', err);
    alert('Fehler beim Laden der LBMA-Daten. Bitte Seite neu laden.');
  });
</script>
